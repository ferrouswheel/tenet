<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenet</title>
    <style>
        {{STYLES}}
    </style>
</head>
<body>
    <div class="header">
        <div style="display:flex;align-items:center;gap:0.75rem;">
            <h1>Tenet</h1>
            <span class="status-dot" id="status-dot"></span>
        </div>
        <nav class="header-nav">
            <button class="header-nav-btn active" id="nav-feed" title="Public Feed" onclick="navToFeed()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            </button>
            <button class="header-nav-btn" id="nav-groups" title="Groups" onclick="navToGroups()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </button>
            <button class="header-nav-btn" id="nav-friends" title="Friends" onclick="navToFriends()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            </button>
            <button class="header-nav-btn" id="nav-peers" title="Peers" onclick="navToPeers()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/><line x1="16" y1="11" x2="22" y2="11"/><line x1="19" y1="8" x2="19" y2="14"/></svg>
            </button>
            <button class="header-nav-btn" id="nav-profile" title="My Profile" onclick="navToProfile()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            </button>
        </nav>
        <div style="display:flex;align-items:center;gap:1rem;">
            <div class="peer-id" id="peer-id" title=""></div>
            <!-- Notification bell (Phase 11) -->
            <div class="notification-bell" id="notification-bell" onclick="toggleNotificationPanel()">
                <span class="bell-icon">&#128276;</span>
                <span class="notification-badge" id="notification-badge" style="display:none;">0</span>
            </div>
        </div>
    </div>

    <!-- Notification panel (Phase 11) -->
    <div class="notification-panel" id="notification-panel">
        <div class="notification-panel-header">
            <span>Notifications</span>
            <button onclick="markAllNotificationsRead()">Mark all read</button>
        </div>
        <div class="notification-list" id="notification-list"></div>
    </div>

    <!-- Relay status banner -->
    <div class="relay-banner" id="relay-banner" style="display:none;">
        <span class="relay-banner-icon">&#9888;</span>
        <span id="relay-banner-text">Relay unavailable</span>
        <button class="relay-retry-btn" id="relay-retry-btn" onclick="retryRelayConnection()">Retry now</button>
    </div>

    <!-- Update available banner -->
    <div class="update-banner" id="update-banner" style="display:none;">
        <span class="update-banner-icon">&#8593;</span>
        <span>A new version is available.</span>
        <a class="update-reload-link" href="javascript:location.reload()">Reload</a>
        <button class="update-dismiss-btn" onclick="dismissUpdateBanner()" title="Dismiss">&#10005;</button>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- My profile (Phase 10) -->
            <div class="profile-card" id="my-profile-card" onclick="showMyProfile()">
                <div class="profile-avatar" id="my-profile-avatar"></div>
                <div class="profile-info">
                    <div class="profile-name" id="my-profile-name">Me</div>
                    <div class="profile-bio" id="my-profile-bio"></div>
                </div>
            </div>
            <div class="peer-id-display" id="peer-id-display">
                <span class="peer-id-label">Your Peer ID</span>
                <div class="peer-id-row">
                    <code class="peer-id-full" id="peer-id-full"></code>
                    <button class="copy-btn" onclick="event.stopPropagation();copyPeerId()" title="Copy Peer ID">Copy</button>
                </div>
            </div>

        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- Filter tabs -->
            <div class="filters">
                <button class="active" data-kind="public">Public</button>
                <button data-kind="friend_group">Groups</button>
                <button id="groups-new-btn" style="display:none;" onclick="toggleGroupCreateForm()">+ New Group</button>
            </div>

            <!-- Group invites panel (shown when in groups view, if there are pending invites) -->
            <div id="group-invites-panel" style="display:none;"></div>

            <!-- Group create form (shown when in groups view) -->
            <div id="group-create-form" class="group-create-form" style="display:none;">
                <h3>Create Group</h3>
                <label>Group ID</label>
                <input type="text" id="group-id-input" placeholder="e.g. friends, work-team" />
                <label>Members (from your friends)</label>
                <div id="group-member-checkboxes" class="group-member-list"></div>
                <div class="form-actions">
                    <button class="btn-secondary" onclick="toggleGroupCreateForm()">Cancel</button>
                    <button class="btn-primary" onclick="submitCreateGroup()">Create Group</button>
                </div>
            </div>

            <!-- Compose box -->
            <div class="compose" id="compose-box">
                <textarea id="compose-body" placeholder="Write a message..."></textarea>
                <div class="compose-attachments">
                    <div class="attachment-picker">
                        <label for="attachment-input">Attach file</label>
                        <input type="file" id="attachment-input" multiple onchange="handleFileSelect(this.files)" />
                    </div>
                    <div class="attachment-previews" id="attachment-previews"></div>
                </div>
                <div class="compose-actions">
                    <select id="compose-kind">
                        <option value="public">Public</option>
                    </select>
                    <select id="compose-group-id" style="display:none;"></select>
                    <select id="compose-geo-mode" title="Location metadata mode">
                        <option value="none">Geo: none</option>
                        <option value="country">Geo: country</option>
                        <option value="region">Geo: region</option>
                        <option value="city">Geo: city</option>
                        <option value="neighborhood">Geo: neighborhood</option>
                        <option value="exact">Geo: exact</option>
                    </select>
                    <input id="compose-geo-country" type="text" placeholder="Country (US)" style="display:none;max-width:120px;" />
                    <input id="compose-geo-region" type="text" placeholder="Region" style="display:none;max-width:180px;" />
                    <input id="compose-geo-city" type="text" placeholder="City" style="display:none;max-width:180px;" />
                    <input id="compose-geo-geohash" type="text" placeholder="Geohash" style="display:none;max-width:140px;" />
                    <input id="compose-geo-lat" type="number" step="any" placeholder="Lat" style="display:none;max-width:120px;" />
                    <input id="compose-geo-lon" type="number" step="any" placeholder="Lon" style="display:none;max-width:120px;" />
                    <button id="compose-send" onclick="sendMessage()">Send</button>
                </div>
            </div>

            <!-- Timeline -->
            <div id="timeline"></div>

            <!-- Conversation detail (DMs with a friend, accessed from sidebar) -->
            <div id="conversation-detail" class="conversation-detail">
                <div class="conversation-back">
                    <button onclick="navigateTo('timeline')">&#8592; Back to Feed</button>
                    <span class="peer-name" id="conversation-peer-name"></span>
                </div>
                <!-- Peer info header -->
                <div class="dm-peer-info" id="dm-peer-info"></div>
                <div class="dm-messages-area" id="dm-messages-area">
                    <div id="conversation-load-more" class="load-more" style="display:none;">
                        <button onclick="loadMoreConversationMessages()">Load older messages</button>
                    </div>
                    <div id="conversation-messages"></div>
                </div>
            </div>

            <!-- Post detail -->
            <div id="post-detail" class="post-detail">
                <div class="post-detail-back">
                    <button onclick="navigateTo('timeline')">&#8592; Back to Feed</button>
                </div>
                <div id="post-detail-content"></div>
                <!-- Reply compose (Phase 9) -->
                <div class="reply-compose" id="reply-compose">
                    <textarea id="reply-body" placeholder="Write a comment..."></textarea>
                    <div class="reply-compose-actions">
                        <button onclick="sendReply()">Comment</button>
                    </div>
                </div>
                <!-- Comments list -->
                <div id="post-replies"></div>
                <div id="replies-load-more" class="load-more" style="display:none;">
                    <button onclick="loadMoreReplies()">Load more comments</button>
                </div>
            </div>

            <!-- Profile view (Phase 10) -->
            <div id="profile-view" class="profile-view">
                <div class="profile-view-back">
                    <button onclick="backFromProfile()">&#8592; Back</button>
                </div>
                <div id="profile-view-content"></div>
            </div>

            <!-- Profile edit (Phase 10) -->
            <div id="profile-edit" class="profile-edit">
                <div class="profile-edit-back">
                    <button onclick="backFromProfile()">&#8592; Back</button>
                    <span>Edit Profile</span>
                </div>
                <div class="profile-edit-form">
                    <label>Your Peer ID</label>
                    <div class="profile-peer-id-row">
                        <code class="profile-peer-id" id="profile-edit-peer-id"></code>
                        <button type="button" class="copy-btn" onclick="copyPeerId()">Copy</button>
                    </div>
                    <!-- QR code for peer discovery -->
                    <div class="profile-qr-section">
                        <div id="profile-qr-container" class="profile-qr-container"></div>
                    </div>
                    <label>Display Name</label>
                    <input type="text" id="profile-display-name" placeholder="Your name" />
                    <label>Bio</label>
                    <textarea id="profile-bio" placeholder="Tell us about yourself..." rows="3"></textarea>
                    <label>Profile Photo</label>
                    <div class="avatar-upload-zone" id="avatar-upload-zone">
                        <div id="avatar-upload-preview"></div>
                        <div class="avatar-upload-overlay">&#128247;</div>
                        <input type="file" id="avatar-file-input" accept="image/*" style="display:none" onchange="handleAvatarFileSelect(this.files)" />
                    </div>
                    <div class="form-actions">
                        <button class="btn-secondary" onclick="backFromProfile()">Cancel</button>
                        <button class="btn-primary" onclick="saveProfile()">Save</button>
                    </div>
                </div>
            </div>

            <!-- Peer list view (#/peers) -->
            <div id="peers-view" class="peers-view">
                <div class="peers-view-header">
                    <h2>Peers</h2>
                </div>
                <div class="peers-tabs">
                    <button class="peer-tab active" data-peer-tab="all" onclick="switchPeerTab('all')">All</button>
                    <button class="peer-tab" data-peer-tab="friends" onclick="switchPeerTab('friends')">Friends</button>
                    <button class="peer-tab" data-peer-tab="verified" onclick="switchPeerTab('verified')">Verified</button>
                    <button class="peer-tab" data-peer-tab="placeholder" onclick="switchPeerTab('placeholder')">Placeholder</button>
                </div>
                <div id="peers-list"></div>
            </div>

            <!-- Peer detail view (#/peers/{peerId}) -->
            <div id="peer-detail-view" class="peer-detail-view">
                <div class="peer-detail-back">
                    <button onclick="navigateTo('peers')">&#8592; Back to Peers</button>
                </div>
                <div id="peer-detail-content"></div>
                <div class="peer-activity-section" id="peer-activity-section" style="display:none;">
                    <h3>Recent Activity</h3>
                    <div id="peer-activity-list"></div>
                    <div id="peer-activity-load-more" class="load-more" style="display:none;">
                        <button onclick="loadMorePeerActivity()">Load more</button>
                    </div>
                </div>
            </div>

            <!-- Friends view -->
            <div id="friends-view" class="friends-view">
                <div class="friends-view-header">
                    <h2>Friends</h2>
                    <div style="display:flex;gap:0.5rem;">
                        <button class="add-friend-btn friends-view-add-btn" onclick="openQrScanner()" title="Scan peer QR code">&#128247; Scan QR</button>
                        <button class="add-friend-btn friends-view-add-btn" onclick="toggleAddFriendForm()">+ Add Friend</button>
                    </div>
                </div>
                <div id="add-friend-form" class="add-friend-form">
                    <h3>Send Friend Request</h3>
                    <input type="text" id="friend-peer-id" placeholder="Peer ID" />
                    <input type="text" id="friend-message" placeholder="Message (optional)" />
                    <div class="form-actions">
                        <button class="btn-secondary" onclick="toggleAddFriendForm()">Cancel</button>
                        <button class="btn-primary" onclick="sendFriendRequest()">Send Request</button>
                    </div>
                </div>
                <div class="friends-page-layout">
                    <div class="friends-page-list">
                        <h3 class="friends-page-section-title">My Friends</h3>
                        <div id="friends-list"></div>
                    </div>
                    <div class="friends-page-requests">
                        <h3 class="friends-page-section-title">
                            Friend Requests <span class="fr-badge" id="fr-pending-badge"></span>
                        </h3>
                        <div class="fr-tabs">
                            <button class="fr-tab active" data-fr-tab="pending" onclick="switchFrTab('pending')">Pending</button>
                            <button class="fr-tab" data-fr-tab="history" onclick="switchFrTab('history')">History</button>
                        </div>
                        <div class="fr-toggle-hidden">
                            <label><input type="checkbox" id="fr-show-hidden" onchange="loadFriendRequests()"> Show blocked &amp; ignored</label>
                        </div>
                        <div id="friend-requests-list"></div>
                    </div>
                </div>
            </div>

            <!-- Load more / empty -->
            <div id="load-more" class="load-more" style="display:none;">
                <button onclick="loadMore()">Load older messages</button>
            </div>
            <div id="empty-state" class="empty" style="display:none;">
                <div class="icon">&#128172;</div>
                <div>No messages yet</div>
            </div>
        </div>
    </div>

    <!-- QR Scanner Modal -->
    <div class="qr-scanner-modal" id="qr-scanner-modal">
        <div class="qr-scanner-dialog">
            <div class="qr-scanner-header">
                <span>Scan Peer QR Code</span>
                <button class="qr-scanner-close" onclick="closeQrScanner()">&#10005;</button>
            </div>
            <div class="qr-video-wrap">
                <video id="qr-video" playsinline muted autoplay></video>
                <canvas id="qr-canvas" style="display:none;"></canvas>
            </div>
            <div class="qr-scan-status" id="qr-scan-status">Starting camera...</div>
            <div class="qr-manual-section">
                <div class="qr-manual-label">Or paste a Tenet URI:</div>
                <div class="qr-manual-row">
                    <input type="text" id="qr-manual-uri" class="qr-manual-input" placeholder="tenet://peer/...?key=..." />
                    <button class="btn-primary" onclick="submitQrManualUri()">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
    {{SCRIPTS}}
    </script>
</body>
</html>

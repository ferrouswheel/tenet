// UniFFI Interface Definition for Tenet Android FFI
// Phase 1: Identity init, sync, list/send messages, peer management
// Phase 2: Conversations, replies, reactions, attachments, group messages

namespace tenet_ffi {};

// ---------------------------------------------------------------------------
// Error type
// ---------------------------------------------------------------------------

[Error]
enum TenetError {
    "Init",
    "Sync",
    "Send",
    "Storage",
    "NotFound",
    "InvalidKey",
};

// ---------------------------------------------------------------------------
// Data transfer types
// ---------------------------------------------------------------------------

dictionary FfiMessage {
    string message_id;
    string sender_id;
    string? recipient_id;
    string kind;
    string? group_id;
    string body;
    i64 timestamp;
    boolean is_read;
    string? reply_to;
};

dictionary FfiPeer {
    string peer_id;
    string? display_name;
    boolean is_online;
    boolean is_blocked;
    boolean is_muted;
    boolean is_friend;
    i64? last_seen;
};

dictionary FfiSyncResult {
    u32 fetched;
    u32 new_messages;
    sequence<string> errors;
};

/// Summary of a single DM conversation (one entry per peer).
dictionary FfiConversation {
    string peer_id;
    string? display_name;
    string? last_message;
    i64 last_timestamp;
    u32 unread_count;
};

/// Aggregated reaction counts plus the local user's own reaction.
dictionary FfiReactionSummary {
    u32 upvotes;
    u32 downvotes;
    /// "upvote" | "downvote" | null
    string? my_reaction;
};

// ---------------------------------------------------------------------------
// TenetClient interface
// ---------------------------------------------------------------------------

interface TenetClient {
    // Initialize (or load) an identity in data_dir and set the relay URL.
    [Throws=TenetError]
    constructor(string data_dir, string relay_url);

    string my_peer_id();
    string relay_url();

    // ---------------------------------------------------------------------------
    // Messages — individual access
    // ---------------------------------------------------------------------------

    /// Fetch a single message by ID, or null if not found.
    [Throws=TenetError]
    FfiMessage? get_message(string message_id);

    /// List messages from the local database.
    /// kind: optional filter — "public" | "direct" | "friend_group"
    [Throws=TenetError]
    sequence<FfiMessage> list_messages(string? kind, u32 limit, i64? before_ts);

    [Throws=TenetError]
    void mark_read(string message_id);

    // ---------------------------------------------------------------------------
    // Direct messages
    // ---------------------------------------------------------------------------

    /// Send an encrypted direct message to a known peer.
    [Throws=TenetError]
    void send_direct(string recipient_id, string body);

    /// List messages exchanged with a specific peer (both directions), newest first.
    [Throws=TenetError]
    sequence<FfiMessage> list_direct_messages(string peer_id, u32 limit, i64? before_ts);

    // ---------------------------------------------------------------------------
    // Public / group messages
    // ---------------------------------------------------------------------------

    [Throws=TenetError]
    void send_public(string body);

    [Throws=TenetError]
    void send_group(string group_id, string body);

    // ---------------------------------------------------------------------------
    // Replies
    // ---------------------------------------------------------------------------

    /// Reply to a public or friend-group message.
    [Throws=TenetError]
    void reply_to(string parent_message_id, string body);

    /// List replies to a message, oldest first (chronological thread order).
    [Throws=TenetError]
    sequence<FfiMessage> list_replies(string parent_message_id, u32 limit, i64? before_ts);

    // ---------------------------------------------------------------------------
    // Reactions
    // ---------------------------------------------------------------------------

    /// Add or update a reaction.  reaction must be "upvote" or "downvote".
    [Throws=TenetError]
    FfiReactionSummary react(string target_message_id, string reaction);

    /// Remove the local user's reaction from a message.
    [Throws=TenetError]
    FfiReactionSummary unreact(string target_message_id);

    /// Get aggregated reaction counts for a message.
    [Throws=TenetError]
    FfiReactionSummary get_reactions(string target_message_id);

    // ---------------------------------------------------------------------------
    // Attachments
    // ---------------------------------------------------------------------------

    /// Content-address and persist raw bytes.  Returns the content hash (key for download).
    [Throws=TenetError]
    string upload_attachment(bytes data, string content_type);

    /// Retrieve attachment bytes by content hash.
    [Throws=TenetError]
    bytes download_attachment(string content_hash);

    // ---------------------------------------------------------------------------
    // Sync
    // ---------------------------------------------------------------------------

    [Throws=TenetError]
    FfiSyncResult sync();

    // ---------------------------------------------------------------------------
    // Conversations
    // ---------------------------------------------------------------------------

    /// List DM conversations grouped by peer, sorted by most-recent-first.
    [Throws=TenetError]
    sequence<FfiConversation> list_conversations();

    // ---------------------------------------------------------------------------
    // Peers
    // ---------------------------------------------------------------------------

    [Throws=TenetError]
    sequence<FfiPeer> list_peers();

    [Throws=TenetError]
    void add_peer(string peer_id, string? display_name, string signing_public_key_hex);

    [Throws=TenetError]
    void remove_peer(string peer_id);
};
